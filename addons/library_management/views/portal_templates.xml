<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_my_loans" name="Mis Préstamos">
        <t t-call="portal.portal_layout">
            <div class="container mt-3">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2><i class="fa fa-book"></i> Mis Préstamos</h2>
                    </div>
                    <div class="col-md-6 text-right">
                        <span class="badge badge-primary">
                            <i class="fa fa-check-circle"></i> Préstamos activos: <t
                                t-esc="member.active_loan_count if member else 0" />/5 </span>
                    </div>
                </div>

                <t t-if="renew_success">
                    <div class="alert alert-success">Préstamo renovado exitosamente. Nueva fecha
                        límite: <t t-esc="loan.due_date" /></div>
                </t>
                <t t-if="request.params.get('error')">
                    <div class="alert alert-danger">No se pudo renovar el préstamo. Contacte al
                        bibliotecario.</div>
                </t>

                <div class="alert alert-info" t-if="not loans">
                    <i class="fa fa-info-circle"></i> Actualmente no tienes libros prestados. </div>

                <div class="table-responsive" t-if="loans">
                    <table class="table table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>Libro</th>
                                <th>Autor</th>
                                <th>Fecha Préstamo</th>
                                <th>Fecha Límite</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="loans" t-as="loan">
                                <tr>
                                    <td>
                                        <t t-esc="loan.book_id.name" />
                                    </td>
                                    <td>
                                        <t t-esc="loan.book_id.author" />
                                    </td>
                                    <td>
                                        <t t-esc="loan.loan_date" />
                                    </td>
                                    <td>
                                        <span
                                            t-att-class="loan.due_date &lt; today and 'text-danger font-weight-bold' or ''">
                                            <t t-esc="loan.due_date" />
                                        </span>
                                    </td>
                                    <td>
                                        <span
                                            t-att-class="'badge px-3 py-2 text-white font-weight-bold rounded-pill ' + {'borrowed': 'bg-success', 'overdue': 'bg-danger', 'returned': 'bg-secondary'}.get(loan.state, 'bg-info')"
                                            style="font-size: 0.95rem;">
                                            <t t-if="loan.state == 'borrowed'">Prestado</t>
                                            <t t-if="loan.state == 'overdue'">Vencido</t>
                                            <t t-if="loan.state == 'returned'">Devuelto</t>
                                        </span>
                                    </td>
                                    <td>
                                        <t t-if="loan.state in ['borrowed', 'overdue']">
                                            <a t-if="loan.state == 'borrowed'"
                                                t-att-href="'/my/loans/%s/renew' % loan.id"
                                                class="btn btn-sm btn-outline-primary">
                                                <i class="fa fa-refresh"></i> Renovar </a>

                                            <a t-att-href="'/my/loans/%s/receipt' % loan.id"
                                                target="_blank"
                                                class="btn btn-sm btn-outline-info ml-2">
                                                <i class="fa fa-receipt"></i> Recibo </a>
                                        </t>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
            </div>
        </t>
    </template>
    <template id="portal_my_home_loans_link" inherit_id="portal.portal_my_home"
        name="Enlace Mis Préstamos">
        <xpath expr="//div[@class='o_portal_my_home']" position="inside">
            <div class="col-12 col-md-6 col-lg-4 mb-4">
                <a href="/my/loans" class="text-decoration-none">
                    <div class="card h-100 shadow-sm border-0 rounded-lg">
                        <div
                            class="card-body d-flex flex-column align-items-start justify-content-center p-4">
                            <div class="mb-2">
                                <i class="fa fa-book fa-2x text-primary"></i>
                            </div>
                            <h5 class="card-title mb-1 text-dark font-weight-bold">Mis Préstamos</h5>
                            <p class="card-text text-muted">Revisa los libros que has solicitado y
                                su estado.</p>
                        </div>
                    </div>
                </a>
            </div>
        </xpath>
    </template>
    <template id="portal_loan_receipt" name="Recibo de Préstamo">
        <t t-call="portal.portal_layout">
            <div class="container mt-5">
                <div class="card p-4 shadow">
                    <h2 class="mb-3"><i class="fa fa-receipt text-primary"></i> Recibo de Préstamo</h2>
                    <p>
                        <strong>Socio:</strong>
                        <t t-esc="member.first_name" />
                        <t t-esc="member.last_name" />
                    </p>
                    <p>
                        <strong>Libro:</strong>
                        <t t-esc="loan.book_id.name" />
                    </p>
                    <p>
                        <strong>Autor:</strong>
                        <t t-esc="loan.book_id.author" />
                    </p>
                    <p>
                        <strong>Fecha de Préstamo:</strong>
                        <t t-esc="loan.loan_date" />
                    </p>
                    <p>
                        <strong>Fecha Límite:</strong>
                        <t t-esc="loan.due_date" />
                    </p>
                    <p>
                        <strong>Estado:</strong>
                        <t t-if="loan.state == 'borrowed'">Prestado</t>
                        <t t-if="loan.state == 'overdue'">Vencido</t>
                        <t t-if="loan.state == 'returned'">Devuelto</t>
                    </p>
                    <a href="/my/loans" class="btn btn-primary mt-3">Volver a Mis Préstamos</a>
                </div>
            </div>
        </t>
    </template>
</odoo>